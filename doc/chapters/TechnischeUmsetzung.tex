\chapter{Numerische Untersuchungen und technische Umsetzung} \label{kap:TUNU}
Das in Gleichung \eqref{equ:mayer_problem} gezeigte Optimalsteuerungsproblem in \autoref{cha:optim} wird numerisch in \textit{MATLAB} implementiert und gelöst. Im Folgenden Kapitel werden Methoden zur Lösung des Differentialgleichungssystems (vgl. Gleichung \eqref{equ:state_space}) verglichen. Desweiteren werden Algorithmen zur Lösung von nichtlinearen Optimierungsproblemen erläutert. Die Implementierung der Lösung des Optimalsteuerungsproblems wird anhand eines Klassendiagramms visualisiert.

\section{Steifigkeitsuntersuchungen}
Die Steifigkeit einer Differentialgleichung beschreibt eine numerische Eigenschaft, die eine Ausgage über die Schrittweite der Lösung erlaubt. Eine Differentialgleichung wird als steif bezeichnet, wenn in einem Bereich der Lösung, die benötigte Schrittweite sehr viel kleiner ist, als es die Krümmung der Lösung erfordert. Dieses Erfordernis kommt mit erheblichem Rechenaufwand.

Um die Steifigkeit der Zustandsdifferentialgleichung des Optimalsteuerungsproblems (vgl. \eqref{equ:state_space}) bewerten zu können, wird ein Steifigkeitskoeffizient der Eigenwerte gebildet \cite{Lambert1991}.

Für den Fall einer linearen Differentialgleichung
\begin{equation} \label{equ:lin_dgl}
    y' = Ay+f(x)
\end{equation}
mit der Lösung
\begin{equation}
    y = \sum_{t=1}^n \kappa_t \cdot \exp^{\lambda t} c_t + g(x)
\end{equation}
ergibt sich der Steifigkeitskoeffizient
\begin{equation}
    \frac{Re(\overline{\lambda})}{Re(\underline{\lambda})}
\end{equation}
mit den Eigenwerten \(Re(\lambda_t) < 0\) mit \(t = 1,\,2,\,...\,,n\).

Da die Differentialgleichungssysteme der Zustandsdifferentialgleichung und der adjungierten Differentialgleichungen nichtliniear sind, wird sie für den Ansatz in Gleichung \eqref{equ:lin_dgl} linearisiert. Aus der Linearisierung nach Taylor folgt somit die Jacobimatrix \(\dfrac{\partial G(t,Z(t),U(t))}{\partial Z}\) (vgl. \eqref{equ:jacobi} für den Fall der adjungierten Differentialgleichungen).

Hier zeigt sich, dass die Forderung \(Re(\lambda_t < 0)\) für \(t=3\) der Matrix \eqref{equ:jacobi} nicht gegeben ist, da der Eigenwert null ist.
Die Steifigkeit des Optimalsteuerungsproblems kann somit nicht über den Steifigkeitsquotienten bewertet werden und wird in den Folgenden Abschnitten experimentell beurteilt.


\section{Numerische Lösung von gewöhnlichen Differentialgleichungen} \label{sec:num_ode}
Das gezeigte Modell des Flugzeugs ist durch ein System von gewöhnlichen Differentialgleichungen abgebildet. Um dieses Modell lösen zu können, werden Methoden von \textit{MATLAB} und eigens implementierte Methoden zur Integration verwendet.
Um die Stabilität der zur Verfügung stehenden Methoden zu überprüfen, werden diese Systeme mit konstanten Werten für die Steuerfunktionen \(T\) und \(C_L\) gelöst. Hierbei werden die Werte innerhalb ihres definierten Intervalls ausgewählt und konstante Werte dem Löser übergeben.

% define new column for ragged right content
\newcolumntype{Z}{>{\raggedright\let\newline\\\arraybackslash\hspace{0pt}}X}
\begin{table}[htbp]
    \centering
    \caption{Untersuchte Einschrittalgorithmen zur Lösung der Zustandsdifferentialgleichung im Vergleich zum expliziten Euler Verfahren}
    \begin{tabularx}{.9\textwidth}{Zccc}
        \toprule
        \textbf{Algorithmus}        & \textbf{Laufzeit} & \textbf{Laufzeitdifferenz } \\
                                    & \textbf{in \text{[$s$]}} & \textbf{in \text{[$s$]}} \\
        \midrule
        explizites Euler Verfahren  &   0,00708 &   0 \\
        implizites Euler Verfahren  &   0,0185  &   0,0115\\
        \textit{MATLAB} \texttt{ode23s}      &   0,0914  &   0,0843 \\
        \textit{MATLAB} \texttt{ode45}       &   0,529   &   0,522 \\
        RADAU-2A Verfahren         &   1,36    &   1,35 \\
        \bottomrule
    \end{tabularx}
\end{table}

\begin{figure}[htbp]
    \centering 
    \subfloat[\label{fig:methods_d_h}]{\includegraphics{../code/methods/results/methods_plot_d_h}}
    \qquad
    \subfloat[\label{fig:methods_d_gamma}]{\includegraphics{../code/methods/results/methods_plot_d_gamma}} \\

    \subfloat[\label{fig:methods_d_x}]{\includegraphics{../code/methods/results/methods_plot_d_x}}
    \qquad
    \subfloat[\label{fig:methods_d_v}]{\includegraphics{../code/methods/results/methods_plot_d_v}}
    \MyCaption{Lösung des Differentialgleichungsmodells (vgl. \eqref{equ:state_space})}{Die vier Zustandgrößen des Vektors wurden mit kontanten Steuerfunktionen \(T\,=\,1259999\,N\) und \(C_L\,=\,1,49\) gelöst.} %
    % \subref{fig:methods_h} zeigt die gleichmäßig steigende Flughöhe mit kleiner Abweichung zwischend en Methoden. \subref{fig:methods_gamma} zeigt den %
    % Anstellwinkel des Flugzeuges mit deutlicher Abweichung zwischen den Algorithmen. \subref{fig:methods_x} zeigt die zurückgelegte Strecke des Flugzeuges.} %
    % \subref{fig:methods_v} zeigt die Geschwindigkeit des Flugzeuges.}
\end{figure}


\paragraph{Explizites Euler Verfahren}
Die vorangeganenen Untersuchungen zeigen, dass sich das explizite Euler Verfahren am Besten mit Hinsicht auf die Laufzeit und die Genauigkeit zur Lösung des gegebenen Optimalsteuerungsproblems eignet. Das Verfahren wurde nach \cite{Brokate2016} in \textit{MATLAB} implementiert.

\section{Beschränkte nichtlineare Optimierungsverfahren}
Bei den direkten Verfahren wird ein Trajektorienoptimierungsproblem durch Umwandlung in ein nichtlineares Programm (NLP) gelöst. Im vorliegenden Projekt wird in \autoref{cha:direct} dabei ein gradientenbasiertes lokales Verfahren verwendet, welches durch die \textit{Optimization Toolbox} von \textit{MATLAB} bereitgestellt wird. Zwei wichtige gradientenbasierte Methoden zur Lösung von beschränkten nichtlinearen Optimierungsproblemen sind die sequentielle quadratische Programmierung (SQP) und das Innere-Punkte-Verfahren (IP). Beide reduzieren dieses Problem in einfachere Teilprobleme und lösen diese nacheinander, bis ein lokales Optimum gefunden ist \cite{Betts2010}.

SQP-Verfahren lösen eine Folge von quadratischen Programmen (QP), um die Abstiegsrichtung zu finden, daher der Name sequentielle quadratische Programmierung. Das Minimum ist erreicht, wenn die Karush-Kuhn-Tucker (KKT)-Bedingungen erfüllt sind \cite{Matlab2016}.

Die \textit{MATLAB}-Funktion \texttt{fmincon} verwendet zwei Varianten der SQP-Methode namens \textit{active-set} und \textit{sqp}. Diese beiden Algorithmen sind sich sehr ähnlich und verwenden eine Quasi-Newton-Methode, um sich einer Lösung zu nähern, die die KKT-Bedingungen erfüllt. Es handelt sich um ein Quasi-Newton-Verfahren, da die Hesse-Matrix nicht exakt berechnet, sondern durch Approximation, in diesem Fall einer BFGS-Update, angenähert wird. Diese Approximation wird vorgenommen, da die Hesse-Matrix oft nicht vorliegt. Sowohl \textit{active-set} als auch \textit{sqp} stellen sicher, dass die Hesse-Matrix positiv definit ist, indem sie die BFGS-Methode mit einer positiv definitiven Matrix initialisieren. Diese Eigenschaft der Hesse-Matrix wird dadurch aufrechterhalten, dass der Algorithmus während des BFGS-Updates verschiedene Matrixoperationen verwendet. Die Bedingung, dass die Hesse-Matrix positiv definit ist, ist zusammen mit den Optimalitätsbedingungen erster Ordnung, die durch die KKT-Bedingungen beschrieben werden, eine notwendige und hinreichende Bedingung für ein Minimum \cite{Matlab2016}. 

Das Innere-Punkt-Verfahren, auch Barrieremethode genannt, löst sukzessive eine Folge von angenäherten Minimierungsproblemen. Der Ansatz besteht in der Umordnung des ursprünglichen Problems unter Verwendung einer Barrierefunktion, in der Regel einer logarithmischen oder inversen Funktion, und dann diese neue Merit-Funktion nach absteigendem $\mu$ zu lösen. Der Algorithmus \texttt{fmincon} verwendet eine logarithmische Barrierefunktion. Im Gegensatz zum SQP-Verfahren erzeugt das IP-Verfahren eine Folge von streng zulässigen Iterierten, die zu einer Lösung aus dem Inneren der zulässigen Menge konvergieren  \cite{Matlab2016}. Für weitere Details siehe \cite{Betts2010}.

\begin{table}[htbp]
    \centering
    \caption{Exit Flags der \textit{MATLAB}-Funktion \texttt{fmincon} }  \label{tab:Exitflag}
    \begin{tabularx}{.9\textwidth}{cZ}
        \toprule
        \textbf{Exit Flag}  & \textbf{Bedeutung} \\
        \midrule
	-2        & Kein zulässiger Punkt gefunden \\
	-1 &  Gestoppt durch Ausgabefunktion oder Plot-Funktion\\
	0 &  Maximale Anzahl an Iterationen erreicht  \\
	1 &  Optimalitätsmaß erster Ordnung kleiner als vorgegeben \\
	2 & Änderung von $x$ kleiner als die vorgegebene Toleranz\\
        \bottomrule
    \end{tabularx}
\end{table}

Die Auswahl des Optimierungsverfahren erfolgte durch numerische Untersuchungen der einzelnen Verfahren und einem Vergleich der Ergebnisse. Ein wichtige Rolle spielte hierbei der Rückgabewert \texttt{exitflag} der Funktion \texttt{fmincon} (vgl. Tabelle \ref{tab:Exitflag}). Bei Werten größer null kann von einem lokalen Minimum ausgegangen werden und bei Werten gleich null sollte die Anzahl der Iterationen erhöht werden. Werte kleiner null zeugen von numerischen Problemen oder Abbrüchen.

 Dabei wurden sowohl die Anzahl der Iterationen, als auch die Funktionswert im Minimum verglichen (Abbildung \ref{img:Vergleich_SQP_IP}). Dabei zeigt sich, dass das SQP-Verfahren für den selben Startwert schneller konvergiert und die Funktionswert kleiner ist. In den folgenden numerischen Untersuchungen wird stets das SQP-Verfahren verwendet.

Dies könnte daran liegen, dass sich beide Steuerungen und teilweise auch die Zustandsvariablen am Rand der zulässigen Menge bewegen und die Barrierefunktion beim IP-Verfahren die Iterierten von den Grenzen der Ungleichheitsbedingungen fern hält \cite{Matlab2016}. Daneben zeigte sich, dass das SQP-Verfahren robuster ist. So hatte die Wahl des Startwertes einen nicht so starken Einfluss wie beim IP-Verfahren und erleichterte die Durchführung der numerischen Experimente. 

\begin{figure}[H]
    \begin{center}
        \includegraphics{images/03_TechnischeUmsetzung/Vergleich_SQP_IP.pdf}
        \MyCaption{Vergleich von IP- und SQP-Verfahren}{Vergleich des Funktionswertes über der Anzahl der Iterationen} \label{img:Vergleich_SQP_IP}
    \end{center}
\end{figure}

\section{Schießverfahren}

Was wird verwendet:
Anfangswert probleme mit einschritt verfahren explizit und implizit
Sensitivitäts DGL
Zusammenbau in Schießverfahren


\section{Aufbau des Lösers}
Das Optimalsteuerungsproblem wurde mit einem direkten Lösungsverfahren und einem indirekten Lösungsverfahren gelöst. Zudem wurden die Untersuchungen in \autoref{sec:num_ode} separat implementiert. Um viel Code wiederverwenden zu können, sind die Löser mit einer Klassenstruktur implementiert. Hierbei ist die Ausgabe über die Klasse \verb+Plotter+ für alle Verfahren wiederverwendbar.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.9\textwidth]{images/03_TechnischeUmsetzung/code_structure}
    \MyCaption{Schematische Darstellung der implementierten Verfahren}{Es wurde ein direktes und ein indirektes Lösungsverfahren implementiert. Alle Verfahren verwenden eine gemeinsame Ausgabe über die Klasse \texttt{Plotter}}
    \label{fig:code_structure}
\end{figure}


\section{Diskussion der numerischen Versuche und Ergebnisse mit direkten Lösungsverfahren}
Das Optimalsteuerungsproblem \ref{prob:MaxRF} mit den Parametern aus Tabelle \ref{tab:ProblemPara} wurden in die Form von Problem \ref{prob:EndNichtOpt} gebracht und technisch in Anhang \ref{Anhang:DirektV} mit \textit{MATLAB} umgesetzt (siehe Kapitel \ref{kap:Versuch0}). Dabei wurden zunächst beide Optimierungsverfahren aus Kapitel \ref{kap:OptVerfahren} auf das Problem angewendet. Während das SQP-Verfahren in Versuch \ref{Versuch01} ein Ergebnis berechnet, welches plausibel erscheint, liefert das Innere-Punkte-Verfahren in Versuch \ref{kap:Versuch02} ein stark oszilierendes, nicht plausibles Ergebnis. Daher wurden zunächst eine die numerische Untersuchungen der beiden Optimierungsverfahren durchgeführt. Es wurden sowohl die Anzahl der Iterationen als auch die Funktionswerte im Minimum verglichen (Abbildung \ref{img:Vergleich_SQP_IP}). Dabei zeigt sich, dass das SQP-Verfahren für den selben Startwert sowohl schneller konvergiert als auch einen kleineren Funktionswert besitzt. Dies könnte daran liegen, dass sich beide Steuerungen und teilweise auch die Zustandsvariablen am Rand der zulässigen Menge bewegen und die Barrierefunktion beim IP-Verfahren die Iterierten von den Grenzen der Ungleichheitsbedingungen fernhält \cite{Matlab2016}. In den nachfolgenden numerischen Untersuchungen wird deshalb stets das SQP-Verfahren verwendet.
\begin{figure}[H]
    \begin{center}
        \includegraphics{images/03_TechnischeUmsetzung/Vergleich_SQP_IP.pdf}
        \caption{Vergleich von IP- und SQP-Verfahren}\label{img:Vergleich_SQP_IP}
    \end{center}
\end{figure}
Trotz alle dem stellt Versuch \ref{kap:Versuch01} kein zufriedenstellendes Ergebnis da. Es konnte kein globales Optmimum erreicht werden (nur Exitflag 2) und auch physikalisch ist diese Lösung für das Flugzeug A380-800 nicht plausibel. Die Steuerstrategie liegt in einer Art Parabelflug, da die Trajektorie der Höhe einer Parabel gleicht (Abbildung \ref{img:Versuch_01}). Das Flugzeug wird möglichst schnell auf eine maximale Höhe gesteuert, um von diesem Punkt aus dann auf die Endhöhe $h_f$ zu segeln. Die physikalischen Grenzen von den berechneten Höhen und Geschwindigkeiten werden dabei deutlich überschritten.

Der Hauptgrund für dieses Problem liegt in der gegebenen festes Endzeit $t_f$ und den fehlenden physikalischen Beschränkungen des Flugzeuges A380-800. Vor allem die fest gegebene Endzeit $t_f$ wirft zunächst die Frage auf, ob für diese Zeitdauer das Steuerungsproblem überhaupt lösbar ist. Um diese Frage zu beantworten wurde das Optimalsteuerungsproblem \ref{prob:MaxRF} und deren Zielfunktion wie in Anhang {kap:OptTf} transformiert auf das Optimalsteuerungsproblem \ref{prob:MaxRFEndzeit}, bei welchem die optimale = minimale Endzeit $t_f$ unter Einhaltung der Start- und Endbedingungen bestimmt wird. Es ergeben sich aus den Versuchen \ref{kap:Versuch0_OptTf} und \ref{kap:Versuch1_OptTf} die optimalen Endzeiten $t_f = ...$ und $t_f = ...$. Da diese kleiner sind als als die gegebene Endzeit $t_f = 1800 \ s$, ist das Steuerungsproblem demnach lösbar.

Um nun zufriedenstellende Ergebnisse zu erreichen werden verschiedene Versuche aufgestellt, in welchen verschiedene Parameter und die gegebene Endzeit $t_f$ variieren, beziehungsweise neue Parameter und Beschränkungen eingeführt sind. 

In Versuch \ref{kap:Versuch1} wird die gegebenen Endzeit $t_f$ von $1800 \ s$ einmal auf $t_f = 300$ (Versuch \ref{kap:Versuch11}) und einmal auf $t_f = 350$ (Versuch \ref{kap:Versuch12}) reduziert. 

In Versuch \ref{kap:Versuch3} wird das Startgewicht $m$ und die Endzeit $t_f$ angepasst. Damit wird das Startgewicht einem real vorkommenden Startgewicht $m = 500.000 \ kg$ für das Flugzeug A380-800 angepasst. Die gegebenen Endzeit $t_f$ wird von $1800 \ s$ einmal auf $t_f = 550$ (Versuch \ref{kap:Versuch31}) und einmal auf $t_f = 600$ (Versuch \ref{kap:Versuch32}) reduziert. 

In Versuch \ref{kap:Versuch4} werden zum angepassten Startgewicht $m = 500.000 \ kg$ und der angepassten Endzeit $t_f$ auch noch zusätzliche physikalische Boxschranken gesetzt, die das Problem und das Flugzeug betreffen. Die gegebenen Endzeit $t_f$ wird von $1800 \ s$ einmal auf $t_f = 550$ (Versuch \ref{kap:Versuch31}) und einmal auf $t_f = 600$ (Versuch \ref{kap:Versuch32}) reduziert.








%Plausible Ergebnisse, nach dem Aspekt der physikalischen Möglichkeiten, wurden in den Versuchen \ref{kap:Versuch11}, \ref{kap:Versuch31} und  \ref{kap:Versuch41} erreicht. Ausschlaggebender Parameter stellt die Endzeit $t_f$ dar, welche über die Qualität des Ergebnisses bestimmt.
%
%Wie ist der Code / technische Umsetzung 
%
%Versuche / Probleme 
%
%Ergebnisse
%
%diskretisierung N=100 mehr bedeutet deutlich größeren Aufwand 
%
%Gedanken wie der Verlauf aussehen könnte:\\
%Am Anfang maximaler Schub und maximaler Auftriebsbeiwert, um so schnell wie möglich die gewünschte Reisehöhe zu erhalten. Auftriebsbeiwert kann dann reduziert werden, um die Geschwindigkeit zu erhöhen. Dies bewirkt eine höhere Geschwindigkeit, wodurch die zurückgelegte Strecke maximiert wird.



\section{Diskussion der numerischen Versuche und Ergebnisse mit indirekten Lösungsverfahren}
Jedoch behandelt das Zweipunkt-Randwertproblem keine Bedingungen wie die Beschränkung des Staudrucks $q(v(t),h(t)) \leq q_{\max}$, wie in Problem \ref{prob:MaxRF} gefordert. Untersuchungen der Ergebnisse aus den Versuchen \ref{kap:Versuch11}, \ref{kap:Versuch31} und  \ref{kap:Versuch41} haben gezeigt, dass diese zu keinem Zeitpunkt den maximalen Wert $q_{\max}$ der Beschränkung erreicht haben (Abbildung \ref{img:test_1_1_staudruck}). Aus Vereinfachungsgründen, wird diese Beschränkung deshalb in diesem Kapitel nicht weiter berücksichtigt.




Die Jacobimatrix F

invertierbar ist. In der Losung y des Randwertproblems ist die Invertierbarkeit dieser Matrix eng verknupft mit der Mangasarian-Fromowitz-Regularitatsbedingung
fur Optimalsteuerungsprobleme.
